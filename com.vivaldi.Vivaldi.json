{
    "app-id": "com.vivaldi.Vivaldi",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "1.6",
    "base": "io.atom.electron.BaseApp",
    "base-version": "stable",
    "branch": "stable",
    "sdk": "org.freedesktop.Sdk",
    "command": "vivaldi",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--device=dri",
        "--share=network",
        "--talk-name=org.freedesktop.Notifications",
        "--talk-name=org.gtk.Notifications",
        "--talk-name=org.kde.StatusNotifierWatcher",
        "--talk-name=org.freedesktop.secrets",
        "--talk-name=org.gnome.SessionManager",
        "--system-talk-name=org.freedesktop.UPower",
        "--system-talk-name=org.freedesktop.NetworkManager"
    ],
    "modules": [
        {
            "name": "gyp",
            "buildsystem": "simple",
            "cleanup": [ "*" ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://chromium.googlesource.com/external/gyp",
                    "commit": "324dd166b7c0b39d513026fa52d6280ac6d56770"
                }
            ],
            "build-commands": [
                "python2 setup.py install --prefix=/app"
            ]
        },
        {
            "name": "nss",
            "buildsystem": "simple",
            "subdir": "nss",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_32_RTM/src/nss-3.32.tar.gz",
                    "sha256": "35c6f381cc96bb25e4f924469f6ba3e57b3a16e0c2fb7e295a284a00d57ed335"
                }
            ],
            "build-commands": [
                "./build.sh --system-sqlite --system-nspr --enable-libpkix -v -o",
                "install -D ../dist/Release/lib/*.so /app/lib"
            ]
        },
        {
            "name": "vivaldi",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/{bin,lib}",
                "cp /usr/bin/ar /app/bin",
                "cp /usr/lib/libbfd-*.so /app/lib",
                "install -Dm755 apply_extra.sh /app/bin/apply_extra",
                "install -Dm755 vivaldi.sh /app/bin/vivaldi",
                "install -Dm644 -t /app/share/appdata/ $FLATPAK_ID.appdata.xml"
            ],
            "sources": [
                {
                    "type": "script",
                    "dest-filename": "apply_extra.sh",
                    "commands": [
                        "export FLATPAK_ID=com.vivaldi.Vivaldi",
                        "ar x vivaldi.deb",
                        "tar xf data.tar.xz",
                        "mv opt/vivaldi .",
                        "install -Dm644 usr/share/applications/vivaldi-stable.desktop export/share/applications/$FLATPAK_ID.desktop",
                        "for s in 16 22 24 32 48 64 128 256; do
                            install -Dm644 vivaldi/product_logo_$s.png export/share/icons/hicolor/${s}x${s}/apps/$FLATPAK_ID.png;
                        done",
                        "sed \"s|Exec=/usr/bin/vivaldi-stable|Exec=vivaldi|g\" -i export/share/applications/$FLATPAK_ID.desktop",
                        "sed \"s|Icon=vivaldi|Icon=$FLATPAK_ID|g\" -i export/share/applications/$FLATPAK_ID.desktop",
                        "rm -r etc usr opt data.tar.xz control.tar.gz debian-binary vivaldi.deb"
                    ]
                },
                {
                    "type": "script",
                    "dest-filename": "vivaldi.sh",
                    "commands": [
                        "exec /app/extra/vivaldi/vivaldi --no-sandbox $@"
                    ]
                },
                {
                    "type": "file",
                    "path": "com.vivaldi.Vivaldi.appdata.xml"
                },
                {
                    "type": "extra-data",
                    "only-arches": [ "x86_64" ],
                    "url": "https://downloads.vivaldi.com/stable/vivaldi-stable_1.15.1147.55-1_amd64.deb",
                    "filename": "vivaldi.deb",
                    "size": 52880244,
                    "sha256": "03c19e76d614b25fc8c36b636334a16d818f549abd2d20df303d15e9096f341e"
                },
                {
                    "type": "extra-data",
                    "only-arches": [ "i386" ],
                    "url": "https://downloads.vivaldi.com/stable/vivaldi-stable_1.15.1147.55-1_i386.deb",
                    "filename": "vivaldi.deb",
                    "size": 52490106,
                    "sha256": "1c38362d3b539df078171bb9b46abd6d0970a1af6091b6c10506fb5f81b142d8"
                },
                {
                    "type": "extra-data",
                    "only-arches": [ "armhf" ],
                    "url": "https://downloads.vivaldi.com/stable/vivaldi-stable_1.15.1147.55-1_armhf.deb",
                    "filename": "vivaldi.deb",
                    "size": 46831370,
                    "sha256": "24858244e3a9bce7cd8600ec655f2856dabbe4c7ad83fb7f7c313674ee31ed1f"
                }
            ]
        }
    ]
}
