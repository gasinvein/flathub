app-id: net.rpcs3.RPCS3
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: "5.13"
command: rpcs3
rename-desktop-file: rpcs3.desktop
rename-appdata-file: rpcs3.appdata.xml
rename-icon: rpcs3
finish-args:
  - --device=all
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
cleanup:
  - /lib/*.a
  - /lib/*.la
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/man
modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json

  - name: evdev
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: "https://freedesktop.org/software/libevdev/libevdev-1.5.7.tar.xz"
        sha256: a1e59e37a2f0d397ffd7e83b73af0e638db83b8dd08902ef0f651a21cc1dd422
    cleanup:
      - /bin

  - name: z3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: "https://github.com/Z3Prover/z3/archive/z3-4.8.7.tar.gz"
        sha256: 8c1c49a1eccf5d8b952dadadba3552b0eac67482b8a29eaad62aa7343a0732c3
    cleanup:
      - /bin

  - name: rpcs3
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      env:
        CC: clang
        CXX: clang++
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DUSE_ALSA=OFF
      - -DUSE_SYSTEM_LIBPNG=ON
    post-install:
      - cp -av 3rdparty/FAudio/libFAudio.so* /app/lib/
      - appstream-util modify /app/share/metainfo/rpcs3.appdata.xml id ${FLATPAK_ID}
    sources:
      - type: git
        url: "https://github.com/RPCS3/rpcs3.git"
    cleanup:
      - /include/llvm
      - /include/llvm-c
      - /bin/llvm*

cleanup-commands:
  - |
    icondir=/app/share/icons/hicolor/scalable/apps
    mv $icondir/rpcs3.svg $icondir/rpcs3.orig.svg
    rsvg-convert -f svg -a -w 512 $icondir/rpcs3.orig.svg -o $icondir/rpcs3.svg
    rm $icondir/rpcs3.orig.svg
