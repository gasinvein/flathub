id: com.stratagus.Stratagus
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '18.08'
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=all # for CD ripping
  - --socket=pulseaudio
  - --persist=.stratagus
  - --filesystem=/media # for data extraction
  - --filesystem=/run/media
  - --env=LD_LIBRARY_PATH=/app/lib # force ffmpeg binary to load bundled libs
command: stratagus
cleanup:
  - /lib/*.a
  - /lib/*.la
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/man
modules:
  - name: ffmpeg
    config-opts:
      - --enable-shared
      - --disable-static
      - --enable-gnutls
      - --disable-doc
      - --enable-libtheora
      - --enable-libvorbis
    sources:
      - type: archive
        url: "https://ffmpeg.org/releases/ffmpeg-4.0.2.tar.xz"
        sha256: a95c0cc9eb990e94031d2183f2e6e444cc61c99f6f182d1575c433d62afb2f97
    cleanup:
      - /share/ffmpeg/examples

  - name: cdparanoia
    no-parallel-make: true
    sources:
      - type: archive
        url: "http://downloads.xiph.org/releases/cdparanoia/cdparanoia-III-10.2.src.tgz"
        sha256: 005db45ef4ee017f5c32ec124f913a0546e77014266c6a1c50df902a55fe64df
    cleanup:
      - /man

  - name: imagemagick
    sources:
      - type: archive
        url: "https://github.com/ImageMagick/ImageMagick/archive/7.0.7-35.tar.gz"
        sha256: eb153673ba7ab20ad2551453dbbbf05d5050630b369116230bb2589a6318b0a5
    cleanup:
      - '*'

  - name: lua
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: "https://github.com/LuaDist/lua/archive/5.1.4.tar.gz"
        sha256: f89b27c7973325c30e63117f41588108fcbfaf31bc1dad65cf1fba0ff97f35cb
    cleanup:
      - /share/lua

  - name: tolua++
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: "https://github.com/LuaDist/toluapp/archive/1.0.93.tar.gz"
        sha256: 0a1ff87cb74e7531aec57e2a7cfdf282116647dea3b46223e3cc7c362b55b5bb
    cleanup:
      - /share/toluapp

  - shared-modules/glu/glu-9.0.0.json

  - shared-modules/SDL/SDL-1.2.15.json

  - name: libmikmod
    sources:
      - type: archive
        url: "https://downloads.sourceforge.net/mikmod/libmikmod-3.3.11.1.tar.gz"
        sha256: ad9d64dfc8f83684876419ea7cd4ff4a41d8bcd8c23ef37ecb3a200a16b46d19
    cleanup:
      - /share/info

  - name: libmng
    sources:
      - type: archive
        url: "http://downloads.sourceforge.net/sourceforge/libmng/libmng-2.0.3.tar.xz"
        sha1: 0f141482ffcef6f8cd4413f945a59310ac2e49af

  - name: fluidsynth
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=BOOL:ON
      - -DLIB_SUFFIX=
    sources:
      - type: archive
        url: "https://github.com/FluidSynth/fluidsynth/archive/v1.1.11.tar.gz"
        sha256: da8878ff374d12392eecf87e96bad8711b8e76a154c25a571dd8614d1af80de8

  - name: stormlib
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=BOOL:ON
    sources:
      - type: archive
        url: "https://github.com/ladislav-zezula/StormLib/archive/v9.22.tar.gz"
        sha256: 7ed583aae5549ba1abc68a8fc9a642b28323cdf835941bd9b2b549a7b623e53d

  - name: timgm6mb-soundfont
    buildsystem: simple
    build-commands:
      - install -Dm644 TimGM6mb.sf2 /app/share/soundfonts/TimGM6mb.sf2
    sources:
      - type: archive
        url: "http://http.debian.net/debian/pool/main/t/timgm6mb-soundfont/timgm6mb-soundfont_1.3.orig.tar.gz"
        sha1: 2ba5e0070863970055c74d5a8ed84538e14f6124

  - name: stratagus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DWITH_RENDERER=OpenGL
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DENABLE_USEGAMEDIR=OFF
      - -DENABLE_DEV=ON
      - -DGAMEDIR=/app/bin
    sources:
      - type: git
        url: "https://github.com/Wargus/stratagus.git"
        tag: v2.4.2

  - name: wargus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DGAMEDIR=/app/bin
    sources:
      - type: git
        url: "https://github.com/Wargus/wargus.git"
        tag: v2.4.2
    post-install:
      - install -Dm644 /app/share/pixmaps/wargus.png /app/share/icons/hicolor/64x64/apps/com.stratagus.Stratagus-wargus.png
      - sed 's/Icon=/Icon=com.stratagus.Stratagus-/g' -i /app/share/applications/wargus.desktop
      - mv /app/share/applications/{,com.stratagus.Stratagus-}wargus.desktop

  - name: stargus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DGAMEDIR=/app/bin
    sources:
      - type: git
        url: "https://github.com/Wargus/stargus.git"
        commit: "17e1881"
    post-install:
      - mv /app/games/stargus /app/bin/
      - rmdir /app/games
      - install -Dm644 /app/share/pixmaps/stargus.png /app/share/icons/hicolor/32x32/apps/com.stratagus.Stratagus-stargus.png
      - sed 's/Icon=/Icon=com.stratagus.Stratagus-/g' -i /app/share/applications/stargus.desktop
      - mv /app/share/applications/{,com.stratagus.Stratagus-}stargus.desktop

  - name: war1gus
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DGAMEDIR=/app/bin
    sources:
      - type: git
        url: "https://github.com/Wargus/war1gus.git"
        tag: v2.4.2
    post-install:
      - install -Dm644 /app/share/pixmaps/war1gus.png /app/share/icons/hicolor/64x64/apps/com.stratagus.Stratagus-war1gus.png
      - sed 's/Icon=/Icon=com.stratagus.Stratagus-/g' -i /app/share/applications/war1gus.desktop
      - mv /app/share/applications/{,com.stratagus.Stratagus-}war1gus.desktop
