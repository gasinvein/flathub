id: org.peazip.PeaZip
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: "19.08"
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
command: peazip
rename-icon: peazip
rename-desktop-file: peazip.desktop
sdk-extensions:
  - org.freedesktop.Sdk.Extension.freepascal
build-options:
  prepend-path: /usr/lib/sdk/freepascal/bin
  env:
    PPC_CONFIG_PATH: /usr/lib/sdk/freepascal/etc
cleanup:
  - /include
  - /lib/*.a
  - /lib/*.la
  - /share/man
  - /share/doc
modules:

  - name: peazip
    buildsystem: simple
    build-commands:
      - lazbuild --widgetset=gtk2 --build-all project_pea.lpi project_peach.lpi
      - |
        peadir=/app/lib/peazip
        mkdir -p ${peadir}
        cp -a res ${peadir}/
        install -Dm755 peazip -t ${peadir}/
        install -Dm755 pea -t ${peadir}/res/
        for i in 7z upx; do
          mkdir ${peadir}/res/${i}
          ln -sr /app/bin/${i} ${peadir}/res/${i}/${i}
        done
        mkdir -p ${FLATPAK_DEST}/bin
        ln -sr ${peadir}/peazip ${FLATPAK_DEST}/bin/peazip
        ln -sr ${peadir}/res/pea ${FLATPAK_DEST}/bin/pea
      - |
        cd FreeDesktop_integration
        install -Dm644 peazip.png -t /app/share/icons/hicolor/256x256/apps/
        install -Dm644 "peazip-alt(multilingual).desktop" /app/share/applications/peazip.desktop
    sources:
      - type: archive
        url: "https://downloads.sourceforge.net/peazip/peazip-6.9.2.src.zip"
        sha256: 67fd27bce4ea8c1b2e374d6a68d4cd82f56dc776df025075faa5581842770077
    modules:
      - shared-modules/gtk2/gtk2.json

  - name: p7zip
    no-autogen: true
    make-args:
      - all2
      - OPTFLAGS=-O2 -g
      - DEST_HOME=/app
      - DEST_BIN=/app/bin
      - DEST_SHARE=/app/lib/p7zip
      - DEST_MAN=/app/share/man
    make-install-args:
      - DEST_HOME=/app
      - DEST_BIN=/app/bin
      - DEST_SHARE=/app/lib/p7zip
      - DEST_MAN=/app/share/man
    sources:
      - type: archive
        url: "https://downloads.sourceforge.net/p7zip/p7zip_16.02_src_all.tar.bz2"
        sha256: 5eb20ac0e2944f6cb9c2d51dd6c4518941c185347d4089ea89087ffdd6e2341f
      - type: shell
        only-arches:
          - "x86_64"
        commands:
          - ln -sf makefile.linux_amd64_asm makefile.machine
      - type: shell
        only-arches:
          - "i386"
        commands:
          - ln -sf makefile.linux_x86_asm_gcc_4.X makefile.machine
    modules:

      - name: yasm
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: "https://github.com/yasm/yasm/archive/v1.3.0.tar.gz"
            sha256: f708be0b7b8c59bc1dbe7134153cd2f31faeebaa8eec48676c10f972a1f13df3
        cleanup:
          - "*"

  - name: upx
    no-autogen: true
    make-args:
      - all
    no-make-install: true
    build-commands:
      - install -Dm755 src/upx.out /app/bin/upx
    sources:
      - type: archive
        url: "https://github.com/upx/upx/releases/download/v3.95/upx-3.95-src.tar.xz"
        sha256: 3b0f55468d285c760fcf5ea865a070b27696393002712054c69ff40d8f7f5592
    modules:

      - name: ucl
        build-options:
          cflags: -std=gnu90
        config-opts:
          - --enable-shared
          - --disable-static
        sources:
          - type: archive
            url: "https://www.oberhumer.com/opensource/ucl/download/ucl-1.03.tar.gz"
            sha256: b865299ffd45d73412293369c9754b07637680e5c826915f097577cd27350348
