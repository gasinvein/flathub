id: com.ylsoftware.Qmmp
sdk: org.kde.Sdk
runtime: org.kde.Platform
runtime-version: "5.12"
command: qmmp
rename-icon: qmmp
rename-desktop-file: qmmp.desktop
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --own-name=org.mpris.qmmp
  - --own-name=org.mpris.MediaPlayer2.qmmp
  - --talk-name=org.freedesktop.Notifications
  - --system-talk-name=org.freedesktop.UDisks2
  - --persist=.qmmp
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/pkgconfig
  - /share/aclocal
  - /lib/cmake
  - /share/doc
  - /share/man
  - /share/info
modules:
  - name: qmmp
    buildsystem: cmake-ninja
    config-opts:
      - -DUSE_ALSA:BOOL=FALSE
      - -DUSE_PULSE:BOOL=TRUE
      - -DQMMP_DEFAULT_OUTPUT=pulse
      - -DPROJECTM_CONFIG=/app/share/projectM/config.inp
    post-install:
      - mv /app/share/applications/{qmmp_,${FLATPAK_ID}.}dir.desktop
      - mv /app/share/applications/{qmmp_,${FLATPAK_ID}.}enqueue.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.dir.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.enqueue.desktop
    sources:
      - type: archive
        url: "http://qmmp.ylsoftware.com/files/qmmp-1.2.6.tar.bz2"
        md5: fd4394057e51f5748a12554ee2483613
    modules:

      - name: taglib
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_SHARED_LIBS=BOOL:ON
        sources:
          - type: archive
            url: "http://taglib.org/releases/taglib-1.11.1.tar.gz"
            sha256: b6d1a5a610aae6ff39d93de5efd0fdc787aa9e9dc1e7026fa4c961b26563526b

      - name: libcdio-paranoia
        config-opts:
          - --disable-example-progs
        sources:
          - type: archive
            url: "https://github.com/rocky/libcdio-paranoia/archive/release-10.2+0.94+2.tar.gz"
            sha256: 6cbd80c19bd79002e8a6b4d52c3379e822b84d83614087d2f9ff10d400c58e83
          - type: script
            dest-filename: autogen.sh
            commands:
              - autoreconf -fiv
        modules:

          - name: libcdio
            config-opts:
              - --enable-shared
              - --disable-static
              - --enable-cddb
              - --without-cdda-player
              - --without-cd-drive
              - --without-cd-info
              - --without-cd-read
              - --without-iso-info
              - --without-iso-read
            sources:
              - type: archive
                url: "https://ftp.gnu.org/gnu/libcdio/libcdio-2.0.0.tar.gz"
                sha256: 1b481b5da009bea31db875805665974e2fc568e2b2afa516f4036733657cf958
            modules:

              - name: libcddb
                sources:
                  - type: archive
                    url: "http://prdownloads.sourceforge.net/libcddb/libcddb-1.3.2.tar.bz2"
                    sha256: 35ce0ee1741ea38def304ddfe84a958901413aa829698357f0bee5bb8f0a223b

      - name: opusfile
        sources:
          - type: archive
            url: "https://archive.mozilla.org/pub/opus/opusfile-0.9.tar.gz"
            sha256: f75fb500e40b122775ac1a71ad80c4477698842a8fe9da4a1b4a1a9f16e4e979

      - name: libmad
        rm-configure: true
        post-install:
          - install -Dm644 mad.pc -t /app/lib/pkgconfig
        sources:
          - type: archive
            url: "https://downloads.sourceforge.net/mad/libmad-0.15.1b.tar.gz"
            sha256: bbfac3ed6bfbc2823d3775ebb931087371e142bb0e9bb1bee51a76a6e0078690
          - type: script
            dest-filename: autogen.sh
            commands:
              - touch -r aclocal.m4 configure.ac NEWS AUTHORS ChangeLog
              - autoreconf -ifv
          - type: patch
            path: patches/libmad-0.15.1b-cflags.patch
          - type: patch
            path: patches/libmad-0.15.1b-cflags-O2.patch
          - type: file
            path: patches/mad.pc

      - name: soxr
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: "https://downloads.sourceforge.net/soxr/soxr-0.1.3-Source.tar.xz"
            sha256: b111c15fdc8c029989330ff559184198c161100a59312f5dc19ddeb9b5a15889

      - name: libshout
        sources:
          - type: archive
            url: "http://downloads.xiph.org/releases/libshout/libshout-2.2.2.tar.gz"
            sha256: 912a1fdb12d31af757e7881db49321e5b5240bd8bd4199e9fb0ce16d66568160

      - name: libprojectM
        sources:
          - type: archive
            url: "https://github.com/projectM-visualizer/projectm/archive/v3.1.0.tar.gz"
            sha256: 8ddf99dc141e554d76a2ecf8d8c1fe7996051e30fa8dd4fc133ce024c8defba7
        modules:

          - name: glm
            buildsystem: cmake-ninja
            config-opts:
              - -DCMAKE_INSTALL_LIBDIR=lib
            sources:
              - type: archive
                url: "https://github.com/g-truc/glm/releases/download/0.9.9.3/glm-0.9.9.3.zip"
                sha256: 496e855590b8aa138347429b7fc745d66707303fb82c1545260d1888472e137b
            cleanup:
              - "*"

  - name: qmmp-plugin-pack
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: "http://qmmp.ylsoftware.com/files/plugins/qmmp-plugin-pack-1.2.4.tar.bz2"
        md5: 61d461d0ab0d0697ffc9cd52f3bd0928

  - name: qmmp-appdata
    buildsystem: simple
    build-commands:
      - install -Dm644 ${FLATPAK_ID}.appdata.xml -t /app/share/appdata/
    sources:
      - type: file
        path: com.ylsoftware.Qmmp.appdata.xml
