app-id: net.rpcs3.RPCS3
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: "18.08"
command: rpcs3
rename-desktop-file: rpcs3.desktop
rename-icon: rpcs3
finish-args:
  - --device=all
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
cleanup:
  - /lib/*.a
  - /lib/*.la
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/man
  # Qt related
  - /lib/*.prl
  - /doc
  - /mkspecs
modules:
  - name: qt5-qtbase
    build-options:
      cflags: -02 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2
      cxxflags: -O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2
      ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
    config-opts:
      - -confirm-license
      - -opensource
      - -shared
      - -platform
      - linux-g++
      - -optimized-qmake
      - -nomake
      - examples
      - -nomake
      - tests
      - -system-harfbuzz
      - -system-sqlite
      - -accessibility
      - -dbus-linked
      - -fontconfig
      - -glib
      - -icu
      - -openssl-linked
      - -no-pch
      - -no-rpath
      - -no-directfb
      - -no-linuxfb
      - -no-kms
      - -no-cups
      - -system-proxies
      - -gtk
    sources:
      - type: archive
        url: "https://download.qt.io/archive/qt/5.11/5.11.2/submodules/qtbase-everywhere-src-5.11.2.tar.xz"
        sha256: 6381e7c3468d5a1dcfe3683b29eeced192faa0f8a32434fec071a59b8bcd0107
        # NOTE: KDE has a handful of patches on top of this
    cleanup:
      - /bin

  - name: qt5-wayland
    buildsystem: qmake
    sources:
      - type: archive
        url: "https://download.qt.io/archive/qt/5.11/5.11.2/submodules/qtwayland-everywhere-src-5.11.2.tar.xz"
        sha256: 4e35e15da360480a5aef414246f70d29b0252b6a9c7e129e63afba3fb2ecb771
    cleanup:
      - /bin

  - name: qt5-declarative
    buildsystem: qmake
    sources:
      - type: archive
        url: "https://download.qt.io/archive/qt/5.11/5.11.2/submodules/qtdeclarative-everywhere-src-5.11.2.tar.xz"
        sha256: 220d86f8031e9d45f3c369c3fd517aaa4c5783ad62c843a21fa7cc3c0a36f2cd
    cleanup:
      - /bin

  - shared-modules/glu/glu-9.0.0.json
  - shared-modules/glew/glew.json
  - shared-modules/udev/udev-175.json

  - name: evdev
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: "https://freedesktop.org/software/libevdev/libevdev-1.5.7.tar.xz"
        sha256: a1e59e37a2f0d397ffd7e83b73af0e638db83b8dd08902ef0f651a21cc1dd422
    cleanup:
      - /bin

  - name: openal
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: "http://http.debian.net/debian/pool/main/o/openal-soft/openal-soft_1.17.2.orig.tar.bz2"
        sha256: a341f8542f1f0b8c65241a17da13d073f18ec06658e1a1606a8ecc8bbc2b3314
    cleanup:
      - /bin
      - /share

  - name: rpcs3
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DUSE_ALSA=OFF
      - -DUSE_SYSTEM_LIBPNG=ON
    sources:
      - type: git
        url: "https://github.com/RPCS3/rpcs3.git"
        disable-shallow-clone: true
    cleanup:
      - /include/llvm
      - /include/llvm-c
      - /bin/llvm*

  - name: rpcs3-metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 net.rpcs3.RPCS3.appdata.xml -t /app/share/appdata/
    sources:
      - type: file
        path: net.rpcs3.RPCS3.appdata.xml
