id: land.deno.Deno
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: "19.08"
finish-args:
  - --share=network
command: deno
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-nightly
build-options:
  append-path: /usr/lib/sdk/rust-nightly/bin
cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
modules:

  - name: deno
    build-options:
      env:
        CARGO_HOME: /run/build/deno/cargo
        V8_FROM_SOURCE: "1"
        GN: /app/bin/gn
        CLANG_BASE_PATH: /usr
        GN_ARGS: cc_wrapper="ccache" no_inline_line_tables=false
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --verbose --manifest-path Cargo.toml
      - cargo --offline build --release --locked --all-targets
      - cargo run --release --locked --bin deno types > lib.deno.d.ts
    post-install:
      - mkdir -p /app/bin /app/lib/deno
      - install -t /app/lib/deno/ -Dm755 target/release/deno
      - install -t /app/lib/deno/ -Dm755 target/release/libtest_plugin.so
      - install -t /app/lib/deno/ -Dm644 lib.deno.d.ts
      - install -D target/release/gn_out/obj/librusty_v8.a -t ${FLATPAK_DEST}/lib/
      - ln -sr /app/lib/deno/deno /app/bin/deno
    sources:
      - type: git
        url: "https://github.com/denoland/deno.git"
        tag: v1.0.3

      - generated-sources.json
    modules:

      - name: lld
        buildsystem: cmake-ninja
        builddir: true
        cleanup:
          - /lib
          - /include
        sources:
          - type: archive
            url: "https://github.com/llvm/llvm-project/releases/download/llvmorg-8.0.1/lld-8.0.1.src.tar.xz"
            sha256: 9fba1e94249bd7913e8a6c3aadcb308b76c8c3d83c5ce36c99c3f34d73873d88

      - name: gn
        build-options:
          env:
            CC: ccache clang
            CXX: ccache clang++
        buildsystem: simple
        build-commands:
          - python2 build/gen.py
          - ninja -C out -j $FLATPAK_BUILDER_N_JOBS
          - install -Dm755 out/gn{,_unittests} -t /app/bin/
        sources:
          - type: git
            url: "https://gn.googlesource.com/gn"
            disable-shallow-clone: true
        modules:

          - shared-modules/python2.7/python-2.7.json
