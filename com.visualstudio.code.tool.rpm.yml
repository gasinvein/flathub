id: com.visualstudio.code.tool.rpm
branch: '21.08'
build-extension: true
sdk: org.freedesktop.Sdk//21.08
runtime: com.visualstudio.code
runtime-version: stable
separate-locales: false
appstream-compose: false
build-options:
  prefix: /app/tools/rpm
  env:
    C_INCLUDE_PATH: /app/tools/rpm/include
    CPLUS_INCLUDE_PATH: /app/tools/rpm/include
    PYTHONPATH: /app/tools/rpm/lib/python3.9/site-packages
  prepend-path: /app/tools/rpm/bin
  prepend-ld-library-path: /app/tools/rpm/lib
  prepend-pkg-config-path: /app/tools/rpm/lib/pkgconfig
  ldflags: -L/app/tools/rpm/lib
  ldflags-override: true
  strip: true
cleanup:
  - "*.a"
  - "*.la"
  - /share/man
modules:

  - name: rpm
    config-opts:
      - --enable-rpath
      - --enable-python
      - --with-crypto=openssl
      - --sysconfdir=/var/config
      - --localstatedir=/var/data
      - --sharedstatedir=/var/data/lib
    sources:
      - type: archive
        url: "http://ftp.rpm.org/releases/rpm-4.15.x/rpm-4.15.0.tar.bz2"
        sha256: 1e06723b13591e57c99ebe2006fb8daddc4cf72efb366a64a34673ba5f61c201
    modules:

      - name: libdb
        subdir: build_unix
        sources:
          - type: archive
            url: "http://download.oracle.com/berkeley-db/db-5.3.28.tar.gz"
            sha256: e0a992d740709892e81f9d93f06daf305cf73fb81b545afe72478043172c3628
          - type: script
            dest: build_unix
            dest-filename: configure
            commands:
              - exec ../dist/configure "$@"
        cleanup:
          - /docs

      - shared-modules/lua5.3/lua-5.3.5.json

      - name: popt
        sources:
          - type: archive
            url: https://github.com/rpm-software-management/popt/archive/refs/tags/popt-1.18-release.tar.gz
            sha256: 36245242c59b5a33698388e415a3e1efa2d48fc4aead91aeb2810b4c0744f4e3

  - name: rpmdevtools
    sources:
      - type: archive
        url: "https://releases.pagure.org/rpmdevtools/rpmdevtools-9.1.tar.xz"
        sha256: 649487d72515de6fa7141cfed32809e6439591076cbfd30218696f6cc2e207ab
      - type: shell
        commands:
          - grep -lF "/usr/bin/python " * | xargs sed -i -e "s|/usr/bin/python |/usr/bin/python3 |"
    modules:

      - python3-progressbar2.json
      - python3-requests_download.json

  - name: rpmlint
    no-autogen: true
    make-install-args:
      - PYTHON=/usr/bin/python3
      - BINDIR=$(FLATPAK_DEST)/bin
      - LIBDIR=$(FLATPAK_DEST)/share/rpmlint
      - ETCDIR=$(FLATPAK_DEST)/etc
      - MANDIR=$(FLATPAK_DEST)/share/man
    post-install:
      - sed "s|/usr/share/rpmlint|${FLATPAK_DEST}/share/rpmlint|g" -i ${FLATPAK_DEST}/bin/rpmlint
    sources:
      - type: archive
        url: "https://github.com/rpm-software-management/rpmlint/archive/rpmlint-1.11.tar.gz"
        sha256: 2ea1f4726382bcf24652ea710b4e98fdfd7f83a7c44a7ee2f5eaf5b201be9ac3

  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - install -Dm755 enable.sh -t ${FLATPAK_DEST}/
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: script
        dest-filename: enable.sh
        commands:
          - export PATH=$PATH:/app/tools/rpm/bin
          - |
            rpm_sdk_python=/app/tools/rpm/lib/python3.9/site-packages
            if [ -z "$PYTHONPATH" ]; then
              export PYTHONPATH=$rpm_sdk_python
            else
              export PYTHONPATH=$PYTHONPATH:$rpm_sdk_python
            fi
      - type: file
        path: com.visualstudio.code.tool.rpm.metainfo.xml
