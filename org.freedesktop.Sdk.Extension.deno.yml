id: org.freedesktop.Sdk.Extension.deno
branch: "19.08"
build-extension: true
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Sdk
runtime-version: "19.08"
separate-locales: false
appstream-compose: false
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-nightly
build-options:
  prepend-path: /usr/lib/sdk/deno/bin
  append-path: /usr/lib/sdk/rust-nightly/bin
  prefix: /usr/lib/sdk/deno
  strip: true
modules:

  - name: deno
    build-options:
      env:
        CARGO_HOME: /run/build/deno/cargo
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --verbose --manifest-path Cargo.toml
      - install -D ${FLATPAK_DEST}/lib/librusty_v8.a -t target/release/gn_out/obj/
      - cargo --offline build --release --locked --all-targets
      - cargo run --release --locked --bin deno types > lib.deno.d.ts
    post-install:
      - mkdir -p ${FLATPAK_DEST}/bin ${FLATPAK_DEST}/lib/deno
      - install -t ${FLATPAK_DEST}/lib/deno/ -Dm755 target/release/deno
      - install -t ${FLATPAK_DEST}/lib/deno/ -Dm755 target/release/libtest_plugin.so
      - install -t ${FLATPAK_DEST}/lib/deno/ -Dm644 lib.deno.d.ts
      - ln -sr ${FLATPAK_DEST}/lib/deno/deno ${FLATPAK_DEST}/bin/deno
    sources:
      - type: git
        url: "https://github.com/denoland/deno.git"
        tag: v1.0.0

      - generated-sources.json
    modules:

      - name: gn
        build-options:
          env:
            CC: ccache clang
            CXX: ccache clang++
        buildsystem: simple
        build-commands:
          - python2 build/gen.py
          - ninja -C out -j $FLATPAK_BUILDER_N_JOBS
          - install -Dm755 out/gn{,_unittests} -t ${FLATPAK_DEST}/bin/
        sources:
          - type: git
            url: "https://gn.googlesource.com/gn"
            disable-shallow-clone: true
        modules:

          - shared-modules/python2.7/python-2.7.json

      - name: rusty_v8
        build-options:
          env:
            CARGO_HOME: /run/build/rusty_v8/cargo
            V8_FROM_SOURCE: "1"
            GN: gn
            CLANG_BASE_PATH: /usr
            #FIXME Why doesn't FD.o SDK include lld?
            GN_ARGS: cc_wrapper="ccache" no_inline_line_tables=false use_lld=false
        buildsystem: simple
        build-commands:
          - cargo --offline fetch --verbose --manifest-path Cargo.toml
          - cargo --offline build -vv --release --locked --all-targets
          - install -D target/release/gn_out/obj/librusty_v8.a -t ${FLATPAK_DEST}/lib/
        sources:
          - type: git
            url: https://github.com/denoland/rusty_v8.git
            tag: v0.4.2
          - generated-sources-rusty_v8.json
